// Module included in the following assemblies:
// install/ossm-deploying-multiple-service-meshes-on-single-cluster.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-deploy-application-workloads-in-each-mesh_{context}"]
= Deploy application workloads in each mesh

To deploy application workloads, assign each workload to a separate namespace.

.Procedure

. Create an application namespace called `app-ns-1` by running the following command:
+
[source,terminal]
----
$ oc create namespace app-ns-1
----

. To ensure that the namespace is discovered by the first control plane, add the `istio-discovery=mesh-1` label by running the following command:
+
[source,terminal]
----
$ oc label namespace app-ns-1 istio-discovery=mesh-1
----

. To enable sidecar injection into all the pods by default while ensuring that pods in this namespace are mapped to the first control plane, add the `istio.io/rev=mesh-1` label to the namespace by running the following command:
+
[source,terminal]
----
$ oc label namespace app-ns-1 istio.io/rev=mesh-1
----

. Optional: You can verify the `mesh-1` revision name by running the following command:
+
[source,terminal]
----
$ oc get istiorevisions
----

. Deploy the `sleep` and `httpbin` applications by running the following command:
+
[source,terminal]
----
$ oc apply -n app-ns-1 \
   -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/sleep/sleep.yaml \
   -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/httpbin/httpbin.yaml
----

. Wait for the `httpbin` and `sleep` pods to run with sidecars injected by running the following command:
+
[source,terminal]
----
$ oc get pods -n app-ns-1
----
+
.Example output
[source,terminal]
----
NAME                       READY   STATUS    RESTARTS   AGE
httpbin-7f56dc944b-kpw2x   2/2     Running   0          2m26s
sleep-5577c64d7c-b5wd2     2/2     Running   0          91m
----

. Create a second application namespace called `app-ns-2` by running the following command:
+
[source,terminal]
----
$ oc create namespace app-ns-2
----

. Create a third application namespace called `app-ns-3` by running the following command:
+
[source,terminal]
----
$ oc create namespace app-ns-3
----

. Add the label `istio-discovery=mesh-2` to both namespaces and the revision label `mesh-2` to match the discovery selector of the second control plane by running the following command:
+
[source,terminal]
----
$ oc label namespace app-ns-2 app-ns-3 istio-discovery=mesh-2 istio.io/rev=mesh-2
----

. Deploy the `sleep` and `httpbin` applications to the `app-ns-2` namespace by running the following command:
+
[source,terminal]
----
$ oc apply -n app-ns-2 \
   -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/sleep/sleep.yaml \
   -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/httpbin/httpbin.yaml
----

. Deploy the `sleep` and `httpbin` applications to the `app-ns-3` namespace by running the following command:
+
[source,terminal]
----
$ oc apply -n app-ns-3 \
   -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/sleep/sleep.yaml \
   -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/httpbin/httpbin.yaml
----

. Optional: Use the following command to wait for a deployment to be available:
+
[source,terminal]
----
$ oc wait deployments -n app-ns-2 --all --for condition=Available
----

.Verification

. Verify that each application workload is managed by its assigned control plane by using the `istioctl ps` command after deploying the applications:

.. Verify that the workloads are assigned to the control plane in `istio-system-1` by running the following command:
+
[source,terminal]
----
$ istioctl ps -i istio-system-1
----
+
.Example output
[source,terminal]
----
NAME                                  CLUSTER        CDS              LDS              EDS              RDS              ECDS        ISTIOD                            VERSION
httpbin-7f56dc944b-vwfm5.app-ns-1     Kubernetes     SYNCED (11m)     SYNCED (11m)     SYNCED (11m)     SYNCED (11m)     IGNORED     istiod-mesh-1-b69646b6f-kxrwk     1.23.0
sleep-5577c64d7c-d675f.app-ns-1       Kubernetes     SYNCED (11m)     SYNCED (11m)     SYNCED (11m)     SYNCED (11m)     IGNORED     istiod-mesh-1-b69646b6f-kxrwk     1.23.0
----

.. Verify that the workloads are assigned to the control plane in `istio-system-2` by running the following command:
+
[source,terminal]
----
$ istioctl ps -i istio-system-2
----
+
.Example output
[source,terminal]
----
NAME                                  CLUSTER        CDS                LDS                EDS                RDS                ECDS        ISTIOD                            VERSION
httpbin-7f56dc944b-54gjs.app-ns-3     Kubernetes     SYNCED (3m59s)     SYNCED (3m59s)     SYNCED (3m59s)     SYNCED (3m59s)     IGNORED     istiod-mesh-2-8666fdfc6-mqp45     1.23.0
httpbin-7f56dc944b-gnh72.app-ns-2     Kubernetes     SYNCED (4m1s)      SYNCED (4m1s)      SYNCED (3m59s)     SYNCED (4m1s)      IGNORED     istiod-mesh-2-8666fdfc6-mqp45     1.23.0
sleep-5577c64d7c-k9mxz.app-ns-2       Kubernetes     SYNCED (4m1s)      SYNCED (4m1s)      SYNCED (3m59s)     SYNCED (4m1s)      IGNORED     istiod-mesh-2-8666fdfc6-mqp45     1.23.0
sleep-5577c64d7c-m9hvm.app-ns-3       Kubernetes     SYNCED (4m1s)      SYNCED (4m1s)      SYNCED (3m59s)     SYNCED (4m1s)      IGNORED     istiod-mesh-2-8666fdfc6-mqp45     1.23.0
----

. Verify that the application connectivity is restricted to workloads within their respective mesh:

.. Send a request from the `sleep` pod in `app-ns-1` to the `httpbin` service in `app-ns-2` to check that the communication fails by running the following command:
+
[source,terminal]
----
$ oc -n app-ns-1 exec deploy/sleep -c sleep -- curl -sIL http://httpbin.app-ns-2.svc.cluster.local:8000
----
+
The `PeerAuthentication` resources created earlier enforce mutual TLS (mTLS) traffic in `STRICT` mode within each mesh. Each mesh uses its own root certificate, managed by the `istio-ca-root-cert` config map, which prevents communication between meshes. The output indicates a communication failure, similar to the following example:
+
.Example output
[source,terminal]
----
HTTP/1.1 503 Service Unavailable
content-length: 95
content-type: text/plain
date: Wed, 16 Oct 2024 12:05:37 GMT
server: envoy
----

.. Confirm that the communication works by sending a request from the `sleep` pod to the `httpbin` service that are present in the `app-ns-2` namespace which is managed by `mesh-2`. Run the following command:
+
[source,terminal]
----
$ oc -n app-ns-2 exec deploy/sleep -c sleep -- curl -sIL http://httpbin.app-ns-3.svc.cluster.local:8000
----
+
.Example output
[source,terminal]
----
HTTP/1.1 200 OK
access-control-allow-credentials: true
access-control-allow-origin: *
content-security-policy: default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' camo.githubusercontent.com
content-type: text/html; charset=utf-8
date: Wed, 16 Oct 2024 12:06:30 GMT
x-envoy-upstream-service-time: 8
server: envoy
transfer-encoding: chunked
----