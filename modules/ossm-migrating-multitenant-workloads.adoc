// Module included in the following assemblies:
//
// * service-mesh-docs-main/migrating/checklists/ossm-migrating-multitenant.adoc

:_mod-docs-content-type: PROCEDURE
[id="migrating-multitenant-workloads_{context}""]
= Migrating workloads in a multitenant deployment

Now you can migrate your workloads from the {SMProduct} 2.6 control plane to the {SMproduct} 3.0 control plane.

[NOTE]
====
You can migrate workloads and gateways separately, and in any order. For more information, see "Migrating gateways".
====

.Procedure

. Find the current `IstioRevision` for your {SMProduct} 3.0 control plane by running the following command:
+
[source,terminal]
----
$ oc get istios istio-tenant-a
----
+
.Example output
+
[source,terminal]
----
NAME             REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
istio-tenant-a   1           1       0        istio-tenant-a    Healthy   v1.24.3   30s
----
+
[NOTE]
====
The naming format of your revisions depends on which upgrade strategy you choose for your `Istio` instance.
====

. Copy the `ACTIVE REVISION` to use as your `istio.io/rev` label in the next step.

. Update injection labels on the `dataplane` namespace by running the following command:
+
[source,terminal]
----
$ oc label ns bookinfo istio.io/rev=istio-tenant-a maistra.io/ignore-namespace="true" --overwrite=true
----
+
This adds the following labels to the namespace:
+
.. The `istio.io/rev: istio-tenant-a` label: Ensures that any new pods that get created in that namespace connect to the {SMProduct} 3.0 proxy.
+
.. The `maistra.io/ignore-namespace: "true"` label: Disables sidecar injection for {SMProduct} 2.6 proxies in the namespace so {SMProduct} 2.6 stops injecting proxies in this namespace, and any new proxies are injected by {SMProduct} 3.0. Without this label, the {SMProduct} 2.6 injection webhook tries to inject the pod and the injected sidecar proxy will refuse to start since it will have both the {SMProduct} 2.6 and the {SMProduct} 3.0 Container Network Interface(CNI) annotations.
+
[NOTE]
====
Once you apply the `maistra.io/ignore-namespace` label, any new pod that gets created in the namespace will connect to the {SMProduct} 3.0 proxy. Workloads can still communicate with each other regardless of which controlplane they are connected to.
====

. Restart the workloads by using one of the following options:
+
.. To restart all the workloads at once so that the new pods are injected with the {SMProduct} 3.0 proxy, run the following command:
+
.Example command for `bookinfo` application
[source,terminal]
----
$ oc rollout restart deployments -n bookinfo
----

.. To restart each workload individually, run the following command for each workload:
+
.Example command with `bookinfo` application
[source,terminal]
----
$ oc rollout restart deployments productpage-v1 -n bookinfo
----

. Wait for the `productpage` application to restart by running the following command:
+
[source,terminal]
----
$ oc rollout status deployment productpage-v1 -n bookinfo
----

.Verification

. Check that your workload is connected to the new control plane.

.. Fetch the list of proxies that are still connected to the {SMProduct} 2.6 control plane with the `istioctl` tool by running the following command:
+
[source,terminal]
----
$ istioctl ps --istioNamespace istio-system-tenant-a --revision basic
----
+
In this example, `basic` is the name of your `ServiceMeshControlPlane`:
+
.Example output
+
[source,terminal]
----
   NAME                                              CLUSTER        CDS        LDS        EDS        RDS          ECDS         ISTIOD                            VERSION
   details-v1-7b49464bc-zr7nr.bookinfo               Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-basic-6c9f8d9894-sh6lx     1.20.8
   ratings-v1-d6f449f59-9rds2.bookinfo               Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-basic-6c9f8d9894-sh6lx     1.20.8
   reviews-v1-686cd989df-9x59z.bookinfo              Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-basic-6c9f8d9894-sh6lx     1.20.8
   reviews-v2-785b8b48fc-l7xkj.bookinfo              Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-basic-6c9f8d9894-sh6lx     1.20.8
   reviews-v3-67889ffd49-7bhxn.bookinfo              Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-basic-6c9f8d9894-sh6lx     1.20.8
----

.. View the list proxies that have been migrated to the new {SMProduct} 3.0 control plane by running the following command:
+
[source,terminal]
----
$ istioctl ps --istioNamespace istio-system-tenant-a --revision istio-tenant-a
----
+
.Example output
+
[source, terminal]
----
NAME                                         CLUSTER        CDS        LDS        EDS        RDS        ECDS     ISTIOD                      VERSION
productpage-v1-7745c5cc94-wpvth.bookinfo     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED              istiod-5bbf98dccf-n8566     1.24.3
----

. Verify your application is still working correctly. For the `bookinfo` application, run the following command:
+
[source,terminal]
----
$ oc exec -it -n bookinfo deployments/productpage-v1 -c istio-proxy -- curl localhost:9080/productpage
----