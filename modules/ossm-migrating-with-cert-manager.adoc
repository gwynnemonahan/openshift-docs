// Module included in the following assemblies:
//
// * service-mesh-docs-main//migrating/checklists/ossm-migrating-cert-manager-assembly.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-migrating-with-cert-manager_{context}"]
= Migrating with the cert-manager tool

If you are running {SMProduct} {SMv2Product} with the cert-manager tool, you need to perform the following steps to configure the cert-manager tool for {SMProductName} 3 before you create your `Istio` resource, and then you can migrate your deployment.

.Prerequisites

* You have deployed a cluster on {ocp-product-title} 4.14 or later.
* You are logged in to the {ocp-product-title} web console as a user with the cluster-admin role.
* You have completed the premigration checklists.
* You have {SMProduct} {SMv2Version} Operator installed.
* You have {SMProduct} 3 Operator installed.
* You are running either a mulitenant deployment with a single `ServiceMeshControlPlane` resource, or a cluster-wide deployment.
* Your `ServiceMeshControlPlane` is configured with the cert-manager tool:
+
[source,yaml]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
metadata:
  name: basic
  namespace: istio-system
spec:
  ...
  security:
    certificateAuthority:
      cert-manager:
        address: cert-manager-istio-csr.istio-system.svc:443
      type: cert-manager
    dataPlane:
      mtls: true
    identity:
      type: ThirdParty
    manageNetworkPolicy: false
----

.Procedure

. Update the `istio-csr` deployment to include your {SMProduct} 3 control plane:
+
.Example
[source,terminal]
----
  helm upgrade cert-manager-istio-csr jetstack/cert-manager-istio-csr \
      --install \
      --reuse-values \
      --namespace istio-system \
      --wait \
      --set "app.istio.revisions={basic,ossm3-v1-24-1}" <1>
----
+
<1> The `app.istio.revisions` field needs to include your {SMProduct} 3.0 control plane revision _before_ you create your `Istio` resource to ensure that proxies can properly communicate with the {SMProduct} 3.0 control plane.

[NOTE]
====
If you set `spec.updateStrategy.type` to `InPlace` in the {SMProduct} 3 Operator,  your revision name will match your `Istio` name. If you set `spec.updateStrategy.type` to `RevisionBased` in the {SMProduct} 3 Operator, then the revision names use the following format: `<istio-name>-v<major_version>-<minor_version>-<patch_version>`. For example: `ossm3-v1-24-1`.
====

. Unset the `app.controller.configmapNamespaceSelector` field:
+
.Example of unsetting the `app.controller.configmapNamespaceSelector` field
[source,terminal]
----
  helm upgrade cert-manager-istio-csr jetstack/cert-manager-istio-csr \
      --install \
      --reuse-values \
      --namespace istio-system \
      --wait \
      --set "app.controller.configmapNamespaceSelector="
----
+
[NOTE]
====
Unsetting `app.controller.configmapNamespaceSelector` means that istio ca configmap will be injected into every namespace in the cluster. If you have set the `app.controller.configmapNamespaceSelector` field on your `istio-csr` deployment to `maistra.io/member-of`, you can keep it set, but must update it to match your discovery selectors AFTER you have finished migrating your cluster-wide deployment.
====

If the `configmapNamespaceSelector` field on your `istio-csr` deployment is set, the istio CA configmap will only be injected into namespaces that match the label selector. `MultiTenant` deployments with more than one `ServiceMeshControlPlane` in the cluster should not remove this field since the wrong CA configmap would likely get written to the namespace. `ClusterWide` deployments with only a single `SMCP` can choose to leave this unset. If you are keeping the field set, you need to wait until **after** you have completed your migration to update the `configmapNamespaceSelector` field. Otherwise namespaces without the injection label will no longer have the configmap CA injected.

//move this content to done dir
+
.. Update the `app.controller.configmapNamespaceSelector` field after you have completed your migration:
+
.Example of updating
[source,terminal]
----
  helm upgrade cert-manager-istio-csr jetstack/cert-manager-istio-csr \
     --install \
     --reuse-values \
     --namespace istio-system \
     --wait \
     --set "app.controller.configmapNamespaceSelector=istio-injection=enabled"
----
+
[NOTE]
====
Before updating, ensure you have completely finished your migration and the new injection label, in this example `istio-injection=enabled`, is present on all workload namespaces before updating istio-csr.
====
+
. Create the `istio` resource:
+
After updating your istio-csr deployment, you can create the `Istio` resource with the following settings to work with cert-manager. Similar to the 2.6 controlplane, these settings disable the built-in CA server and instead use the istio-csr address.
+
[source,yaml]
----
  apiVersion: sailoperator.io/v1alpha1
  kind: Istio
  metadata:
    name: ossm3
  spec:
    ...
    namespace: istio-system
    values:
      global:
        caAddress: cert-manager-istio-csr.istio-system.svc:443
      pilot:
        env:
          ENABLE_CA_SERVER: "false"
----