
// Module included in the following assemblies:
//
// * service-mesh-docs-main/multitenant/ossm-migrating-multitenant-assembly.adoc

:_mod-docs-content-type: PROCEDURE
[id="migrating-multitenant-with-cert-manager_{context}""]
= Migrating a multitenant deployment with cert-manager

The `bookinfo` example application is being used for demonstration purposes with a minimal example for the `Istio` resource. For more information on configuration differences between the {SMProduct} 2 `ServiceMeshControlPlane` resource and the {SMProduct} 3 `Istio` resource, see "ServiceMeshControlPlane resource to Istio resource fields mapping".

You can follow these same steps with your own workloads.

.Prerequisites

* You have deployed {ocp-product-title} 4.14 or later.
* You are logged in to the {ocp-product-title} web console as a user with the cluster-admin role.
* You have completed the premigration checklists.
* You have the {SMProduct} {SMv2Version} Operator installed.
* You have the {SMProduct} 3 Operator installed.
* You created an `IstioCNI` resource.
* You have the `istioctl` tool installed.
* You are using the cert-manager and istio-csr tools in a multitenant deployment.
//change to "You are using the cert-manager and istio-csr tools in a cluster-wide deployment" for the cluster-wide procedure
* Your {SMProduct} 2 `ServiceMeshControlPlane` is configured with the cert-manager tool.

.Procedure

. Check that your {SMProduct} 2 `ServiceMeshControlPlane` is configured with the cert-manager-tool:
+
.Example `ServiceMeshControlPlane` cert-manager configuration
[source,yaml]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
metadata:
  name: basic
  namespace: istio-system
spec:
  ...
  security:
    certificateAuthority:
      cert-manager:
        address: cert-manager-istio-csr.istio-system.svc:443
      type: cert-manager
    dataPlane:
      mtls: true
    identity:
      type: ThirdParty
    manageNetworkPolicy: false
----

. Update the `istio-csr` deployment to include your {SMProduct} 3 control plane by running the following command:
+
[source,terminal]
----
  helm upgrade cert-manager-istio-csr jetstack/cert-manager-istio-csr \
      --install \
      --reuse-values \
      --namespace istio-system \
      --wait \
      --set "app.istio.revisions={basic,istio-tenant-a}" <1>
----
+
<1> The `app.istio.revisions` field needs to include your {SMProduct} 3.0 control plane revision _before_ you create your `Istio` resource so that proxies can properly communicate with the {SMProduct} 3.0 control plane.

. Create your `Istio` resource.
+
.Example `Istio` resource with cert-manager
+
[source,yaml]
----
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: istio-tenant-a
spec:
  namespace: istio-system-tenant-a <1>
  version: v1.24.3
  values:
    meshConfig:
      discoverySelectors: <2>
        - matchLabels:
            tenant: tenant-a
      extensionProviders:  <3>
        - name: prometheus
          prometheus: {}
        - name: otel
          opentelemetry:
           port: 4317
           service: otel-collector.opentelemetrycollector-3.svc.cluster.local
    global:
      caAddress: cert-manager-istio-csr.istio-system.svc:443
    pilot:
      env:
        ENABLE_CA_SERVER: "false"
----
+
<1> The `spec.namespace` field in your `Istio` resource must be the _same_ namespace as your `ServiceMeshControlPlane` resource. If you set the `spec.namespace` field in your `Istio` resource to a different namespace than your `ServiceMeshControlPlane` resource, the migration will not work properly.
<2> By default, control planes watch the entire cluster. When managing multiple control planes on a single cluster, you must narrow the scope of each control plane by setting `discoverySelectors` fields. In this example, the label `tenant-a` is used, but you can use any label or combination of labels.
<3> Optional: If you are migrating metrics and tracing, update the `extensionProviders` fields according to your tracing and metrics configurations.

. Add your `tenant` label to each one of your dataplane namespaces by running the following command for each dataplane namespace:
+
[source,terminal]
----
$ oc label ns bookinfo tenant=tenant-a
----
+
[NOTE]
====
With {SMProduct} 2.6, namespaces were enrolled into the mesh by adding them to the `ServiceMeshMemberRoll` resource. In {SMProduct} 3, you must label each one of your dataplane namespaces to match your `discoverySelectors` fields.
====