// Module included in the following assemblies:
//
// * service-mesh-docs-main//migrating/checklists/ossm-migrating-cert-manager-assembly.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-migrating-cluster-wide-with-cert-manager_{context}""]
= Migrating a cluster-wide deployment with the cert-manager tool

If you are running a cluster-wide deployment with the cert-manager tool, you need to perform the following steps to configure the cert-manager tool for {SMProductName} 3 before you can migrate your deployment. After you have migrated your deployment, you will create the `Istio` resource, and remove {SMProduct} 2 resources.

.Prerequisites

* You have deployed a cluster on {ocp-product-title} 4.14 or later.
* You are logged in to the {ocp-product-title} web console as a user with the cluster-admin role.
* You have completed the premigration checklists.
* You have {SMProduct} {SMv2Version} Operator installed.
* You have {SMProduct} 3 Operator installed.
* You are running a cluster-wide deployment.
* Your `ServiceMeshControlPlane` is configured with the cert-manager tool:
+
.`ServiceMeshControlPlane` cert-manager configuration
[source,yaml]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
metadata:
  name: basic
  namespace: istio-system
spec:
  ...
  security:
    certificateAuthority:
      cert-manager:
        address: cert-manager-istio-csr.istio-system.svc:443
      type: cert-manager
    dataPlane:
      mtls: true
    identity:
      type: ThirdParty
    manageNetworkPolicy: false
----

.Procedure

. Update the `istio-csr` deployment to include your {SMProduct} 3 control plane by running the following command:
+
[source,terminal]
----
  helm upgrade cert-manager-istio-csr jetstack/cert-manager-istio-csr \
      --install \
      --reuse-values \
      --namespace istio-system \
      --wait \
      --set "app.istio.revisions={basic,ossm3-v1-24-1}" <1>
----
+
<1> The `app.istio.revisions` field needs to include your {SMProduct} 3.0 control plane revision _before_ you create your `Istio` resource to ensure that proxies can properly communicate with the {SMProduct} 3.0 control plane.

[NOTE]
====
If you set `spec.updateStrategy.type` to `InPlace` in the {SMProduct} 3 Operator,  your revision name will match your `Istio` name. If you set `spec.updateStrategy.type` to `RevisionBased` in the {SMProduct} 3 Operator, then the revision names use the following format: `<istio-name>-v<major_version>-<minor_version>-<patch_version>`. For example: `ossm3-v1-24-1`.
====

. Unset the `app.controller.configmapNamespaceSelector` field by running the following command:
+
[source,terminal]
----
  helm upgrade cert-manager-istio-csr jetstack/cert-manager-istio-csr \
      --install \
      --reuse-values \
      --namespace istio-system \
      --wait \
      --set "app.controller.configmapNamespaceSelector="
----
+
[NOTE]
====
Unsetting `app.controller.configmapNamespaceSelector` means that istio ca configmap will be injected into every namespace in the cluster. If you have set the `app.controller.configmapNamespaceSelector` field on your `istio-csr` deployment to `maistra.io/member-of`, you can keep it set for the migration, but you must update it to match your discovery selectors after you have finished migrating your cluster-wide deployment.
====


