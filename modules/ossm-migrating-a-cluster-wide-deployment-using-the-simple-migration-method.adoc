// Module included in the following assemblies:
//
// * service-mesh-docs-main/migrating/cluster-wide/ossm-migrating-cluster-wide-assembly.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-migrating-a-cluster-wide-deployment-using-the-simple-migration-method_{context}"]
= Migrating a cluster-wide deployment by using the simple migration method 

You can perform a canary upgrade with the gradual migration of data plane namespaces for a cluster-wide deployment by using the simple migration method. In an {SMProduct} {SMv2Version} installation, if the `istio-injection=enabled` label is already applied to the data plane namespaces, the simple migration method is the easiest way to migrate from the {SMProduct} 2 installation to the {SMProduct} 3 installation. 

The simple migration method should not be used in production environments. 

[NOTE]
====
Using the simple migration method to migrate from {SMProduct} 2 to {SMProduct} 3 might result in traffic disruption to the services running on a mesh. There are two methods to perform the cluster-wide migration without disrupting traffic. See "Migrating a cluster-wide deployment by using the istio injection label" or "Migrating a cluster-wide deployment by using the Istio revision label" for more information.
====

The `bookinfo` application is used as an example for the `Istio` resource. For more information about configuration differences between the {SMProduct} 2 `ServiceMeshControlPlane` resource and the {SMProduct} 3 `Istio` resource, see "ServiceMeshControlPlane resource to Istio resource fields mapping."

.Prerequisites

* You have deployed {ocp-product-title} 4.14 or later.
* You are logged in to the {ocp-product-title} web console as a user with the `cluster-admin` role.
* You have completed the premigration checklists.
* You have the {SMProduct} {SMv2Version} Operator installed.
* You have the {SMProduct} 3 Operator installed.
* You have created an `IstioCNI` resource.
* You have installed the `istioctl` tool.
* You are running a cluster-wide Service Mesh control plane resource.
* You have installed the `bookinfo` application.

.Procedure

. Identify the namespaces that contain a 2.6 control plane by running the following command:
+
[source,terminal]
----
$ oc get smcp -A
----
+
.Example output
[source,terminal]
----
NAMESPACE      NAME                   READY   STATUS            PROFILES      VERSION   AGE
istio-system   install-istio-system   6/6     ComponentsReady   ["default"]   2.6.6     115m
----

. Create a YAML file named `ossm-3.yaml`. This procedure creates the {istio} resource for the 3.0 installation in the same namespace as the `ServiceMeshControlPlane` resource for the 2.6 installation.
+
[NOTE]
====
In the following example configuration, the {istio} control plane has access to all namespaces on the cluster. If you want to limit the namespaces the control plane has access to, you must define discovery selectors. You must match all the data plane namespaces that you plan to migrate from version 2.6.
====
+
.Example `Istio` resource
[source,yaml,subs="attributes,verbatim"]
----
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default # <1>
spec:
  updateStrategy:
    type: InPlace
  namespace: istio-system # <2>
  version: v1.24.3
  values:  
    meshConfig:
      extensionProviders: # <3>
        - name: prometheus
          prometheus: {}
        - name: otel
          opentelemetry:
            port: 4317
            service: otel-collector.opentelemetrycollector-3.svc.cluster.local
----
<1> The `name`, `updateStrategy` and `version` fields specify how the `IstioRevision` resource name is created. For more information, see "Identifying the revision name."
<2> The 3.0 and 2.6 control planes must run in the same namespace.
<3> If you are migrating metrics and tracing, update the `extensionProviders` fields according to your tracing and metrics configurations.
+
[NOTE]
====
If the {istio} resource is named `default`, and the installation uses the `InPlace` update strategy, you can use the `istio-injection=enabled` label without creating the `IstioRevisionTag` tag. If you use a different name for the {istio} resource or you use the `RevisionBased` update strategy, you must configure the default `IstioRevisionTag` tag. For more information, see "Creating the default revision tag and relabeling the namespaces."
====

. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f ossm-3.yaml
----
+
[NOTE]
====
After you apply the YAML file, any time the workloads are restarted, both the {SMProduct} 2.6 and the {SMProduct} 3.0 control planes will try to inject side cars to all pods in namespaces that have the `istio-injection=enabled` label applied and to all pods that have the `sidecar.istio.io/inject="true"` label applied. This causes a traffic disruption. To prevent traffic disruption, restart the workloads only after the `maistra.io/ignore-namespace: "true"` label is added.
====

.Verification

. Verify that the new `istiod` resource uses the existing root certificate by running the following command:
+
[source,terminal]
----
$ oc logs deployments/istiod -n istio-system | grep 'Load signing key and cert from existing secret'
----
+
.Example output
[source,terminal]
----
2024-12-18T08:13:53.788959Z	info	pkica	Load signing key and cert from existing secret istio-system/istio-ca-secret
----